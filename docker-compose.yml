version: '3.5'
services:

  ## nfs server for hosting test files
  nfs:
    image: erichough/nfs-server:latest
    command: 
    container_name: ute_nfs
    volumes:
      - type: bind
        source: ../samples
        target: /inbound
      - type: bind
        source: ../test
        target: /outbound
    ports:
      - "2049:2049"
    networks:
      ute_net:

  ## RabbitMQ server image is built and deployed
  ## relies on rabbitmq:alpine image
  rabbitmq:
    build:
      context: ./rabbitmq
      dockerfile: Dockerfile
    image: ute:rabbitmq
    container_name: ute_rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672"
    networks:
      ute_net:

  ## defines the flower container for monitoring RabbitMQ
  ## flower will wait for rabbitmq to start first, and then attempt
  ## connection
  flower:
    depends_on:
      - "rabbitmq"
    image: mher/flower:latest
    command: --broker=amqp://utbot:ultimaThule@rabbitmq:5672/utbot_vhost
    command: --broker-api=http://utbot:ultimaThule@rabbitmq:15672/api/
    container_name: ute_flower
    ports:
      - "5555:5555"
    networks:
      ute_net:

  ## defines a celery worker
  worker:
    depends_on:
      - "rabbitmq"
    image: 
    container_name: ute_worker
    volumes:
      - nfs-share:/inbound
      - nfs-share:/outbound
    networks:
      ute_net:

# create the 'ute_net' network if it doesn't exist yet
networks:
  ute_net:
    name: ute_net
    external: true
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.18.100.0/24

## point participating containers (namely the workers) at the NFS container
## we setup up above, as a "local volume"
volumes:
  nfs-share:
    driver: local
    driver_opts:
      type: nfs
      o: nfsvers=4,addr=nfs,rw
      device: "nfs:/"

